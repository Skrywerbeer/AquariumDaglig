// *****************************************************************************
// File: fakkel.h
// Written By: Johan Grobler
// *****************************************************************************
// Peripherals used TCB0 AC0 RTC.
// *****************************************************************************

#ifndef FAKKEL_H
#define FAKKEL_H

#include <avr/io.h>
#include <avr/interrupt.h>

ISR(TCB0_INT_vect);

struct FakkelStatusFlags {
		uint8_t inductorNotReset : 1;
		uint8_t underCurrent : 1;
};

class Fakkel {
	public:
		enum class Powerlevel : uint8_t {
			Level1 = 0,
			Level2,
			Level3,
			Level4,
			Level5
		};
		Fakkel(const uint16_t time=4);
		void setDeadtime(const uint16_t time);
		uint16_t deadtime() const;
		void setReference(VREF_DAC0REFSEL_enum ref);
		void setPowerlevel(const Powerlevel level);
		void operator++();
		void operator--();

		uint8_t enabled() const;
		const FakkelStatusFlags &status() const;
		// Is die nodig?
		void clearStatus();
		void clearInductorNotResetStatus();
		void clearUnderCurrentStatus();
		// ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

		void enable() const;
		void disable() const;
		void toggle() const;
	private:
		void comp_init() const;
		void TCB0_init() const;
		void ports_init() const;
		void rtc_init() const;

		register16_t &_deadtime = TCB0.CCMP;
		uint8_t _powerlevel = 0;
		union {
				FakkelStatusFlags flags;
				uint8_t field;
		} _status;
		friend void TCB0_INT_vect();
};



extern Fakkel fakkel;

#endif // FAKKEL_H
